<section>
  <h2><%= @merchant.username %></h2>

  <% if @merchant.avatar.attached? %>
    <div><%= image_tag @merchant.avatar.variant(resize_to_limit: [200, nil]) %></div>
  <% else %>
    <div><%= image_tag("dog_sleeping.jpg", :alt => "a dog sleeping in a bed, representative of your friendly site builders", :width => 200 ) %></div>
  <% end %>

  <p>Registered seller with Etzzzz since <%= @merchant.created_at.year %></p>
  <p><%= @merchant.description %></p>
  <% if @merchant == @current_merchant %>
    <%= link_to "Update Your Store", edit_merchant_path(@merchant) %>
  <% end %>


  <!--  <p>Questions about an order? <%#= @merchant.email %></p>-->
</section>

<section>
  <h3>Products</h3>
  <% if @merchant == @current_merchant %>
    <%= link_to "Add a new product?", new_product_path %>
  <% end %>

  <table class="table">
    <thead>
      <tr>
        <th>Product</th>
        <th>Description</th>
        <th>Price</th>
        <th>For Sale?</th>
      </tr>
    </thead>

    <% unless @merchant.products.empty? %>
      <tbody>
        <% @merchant.sort_products.each do |product| %>
          <tr>
            <td>
              <%= link_to product.name, product_path(product) %>
              <% if @merchant == @current_merchant %>
                <br/>
                <%= link_to "Update this product?", edit_product_path(product), class: "btn btn-primary" %>
              <% end %>
            </td>
            <td>
              <%= product.description %>
            </td>
            <td>
              <%= display_money(product.price) %>
            </td>
            <td>
              <%= product.for_sale ? "Active" : "Retired" %>
              <% if @merchant == @current_merchant %>
                <%= button_to "Change status?", { action: "toggle_for_sale", controller: "products", id: product.id }, method: :patch, class: "btn btn-secondary" %>
              <% end %>
            </td>
        <% end %>
      </tbody>
    <% end %>
  </table>


</section>

<% if @merchant == @current_merchant %>
  <section>
    <h3>Order history</h3>
    <% if @merchant.orders.empty? %>
      <p>You have no past orders</p>
    <% else %>
      <!--TODO - overall stats, and filter by status -->
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Products</th>
            <th>Quantity</th>
            <th>Subtotal</th>
            <th>Status</th>
          </tr>
        </thead>

        <% @merchant.orders.each do |order| %>
          <tbody>
            <tr>
              <td>
                <%= link_to order.created_at, order_history_path(order) %> <!--TODO - link to the order show view -->
              </td>
              <% items = @merchant.filter_order(order) %>
                <td>
                  <% items.each do |item| %>
                    <%= link_to item.product.name, product_path(item.product) %>
                    <br/>
                  <% end %>
                </td>
                <td>
                  <% items.each do |item| %>
                    <%= item.quantity %>
                    <br/>
                  <% end %>
                </td>
              <td>
                <%= display_money(items.sum { |item| item.product.price }) %>
              </td>
              <td>
                <%= order.status %> <!--TODO - link/dropdown to change status -->
              </td>
            </tr>
          </tbody>
        <% end %>
      </table>

  <% end %>

  </section>
<% end %>
<% if session[:merchant_id] && @order.return_merchants.include?(@current_merchant) %>
  <h2>Order <%= @order.id %>: Items Requested From Your Store</h2>
  <% @order.return_merchant_items(session[:merchant_id]).each do |item| %>
    <p>Product: <%= link_to item.product.name, product_path(item.product) %></p>
    <p>Quantity: <%= item.quantity %><p>
  <%end%>

  <h4>Customer Info</h4>

  <p>Name: <%= @order.name %></p>
  <p>Email Address: <%= @order.email %></p>
  <p>Mailing Address: <%= @order.address %></p>
  <p>Credit Card: **** **** **** <%= @order.credit_card_number.to_s[-4..-1]%></p>
  <p>Credit Card Expiration: <%= @order.expiration_date %>
  <p>Cart Status: <%= @order.status %></p>
  <p>Order placed: <%= @order.updated_at.strftime("%F") %>
<%end%>


